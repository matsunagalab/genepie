name: Build and publish wheels

on:
  push:
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
      - pypi
  workflow_dispatch:

jobs:
  # Step 1: Build GENESIS (atdyn and libpython_interface.so)
  build-genesis:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            arch: x86_64
          - os: macos-latest
            arch: arm64
          - os: macos-15
            arch: x86_64
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y gfortran liblapack-dev libblas-dev autoconf automake libtool

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install gcc lapack autoconf automake libtool
          # Create symlink for gfortran (Homebrew installs versioned, e.g., gfortran-14 or gfortran-15)
          GFORTRAN=$(ls $(brew --prefix)/bin/gfortran-* 2>/dev/null | sort -V | tail -1)
          if [ -n "$GFORTRAN" ]; then
            sudo ln -sf "$GFORTRAN" /usr/local/bin/gfortran
            echo "Linked gfortran: $GFORTRAN"
          fi

      - name: Generate configure script
        run: |
          autoreconf -fi

      - name: Configure GENESIS (no MPI)
        run: |
          if [[ "${{ runner.os }}" == "Linux" ]]; then
            ./configure --disable-mpi CC=gcc FC=gfortran LAPACK_LIBS="-llapack -lblas"
          else
            # macOS - find the highest versioned gcc
            GCC=$(ls $(brew --prefix)/bin/gcc-* 2>/dev/null | grep -E 'gcc-[0-9]+$' | sort -V | tail -1)
            echo "Using GCC: $GCC"
            ./configure --disable-mpi CC="$GCC" FC=gfortran LAPACK_LIBS="-L$(brew --prefix lapack)/lib -llapack -lblas"
          fi

      - name: Build GENESIS
        run: |
          make -j$(nproc 2>/dev/null || sysctl -n hw.ncpu)

      - name: Prepare artifacts
        run: |
          mkdir -p artifacts
          # Copy shared library
          cp lib/libpython_interface.so artifacts/ || cp lib/libpython_interface.dylib artifacts/ || true
          # Copy atdyn binary
          cp src/atdyn/atdyn artifacts/ || true
          # Copy all analysis tool binaries
          # Clustering
          cp src/analysis/clustering/kmeans_clustering/kmeans_clustering artifacts/ || true
          # Converters
          cp src/analysis/converter/cg_convert/cg_convert artifacts/ || true
          cp src/analysis/converter/crd_convert/crd_convert artifacts/ || true
          cp src/analysis/converter/pcrd_convert/pcrd_convert artifacts/ || true
          cp src/analysis/converter/remd_convert/remd_convert artifacts/ || true
          cp src/analysis/converter/rst_convert/rst_convert artifacts/ || true
          cp src/analysis/converter/rst_upgrade/rst_upgrade artifacts/ || true
          # Free energy
          cp src/analysis/free_energy/mbar_analysis/mbar_analysis artifacts/ || true
          cp src/analysis/free_energy/meanforce_analysis/meanforce_analysis artifacts/ || true
          cp src/analysis/free_energy/pmf_analysis/pmf_analysis artifacts/ || true
          cp src/analysis/free_energy/wham_analysis/wham_analysis artifacts/ || true
          # Interface
          cp src/analysis/interface/dssp_interface/dssp_interface artifacts/ || true
          # Mode analysis
          cp src/analysis/mode_analysis/avecrd_analysis/avecrd_analysis artifacts/ || true
          cp src/analysis/mode_analysis/eigmat_analysis/eigmat_analysis artifacts/ || true
          cp src/analysis/mode_analysis/flccrd_analysis/flccrd_analysis artifacts/ || true
          cp src/analysis/mode_analysis/pcavec_drawer/pcavec_drawer artifacts/ || true
          cp src/analysis/mode_analysis/prjcrd_analysis/prjcrd_analysis artifacts/ || true
          # SP analysis
          cp src/analysis/sp_analysis/contact_analysis/contact_analysis artifacts/ || true
          cp src/analysis/sp_analysis/density_analysis/density_analysis artifacts/ || true
          cp src/analysis/sp_analysis/hbond_analysis/hbond_analysis artifacts/ || true
          cp src/analysis/sp_analysis/rdf_analysis/rdf_analysis artifacts/ || true
          cp src/analysis/sp_analysis/sasa_analysis/sasa_analysis artifacts/ || true
          # Trajectory analysis
          cp src/analysis/trj_analysis/comcrd_analysis/comcrd_analysis artifacts/ || true
          cp src/analysis/trj_analysis/diffusion_analysis/diffusion_analysis artifacts/ || true
          cp src/analysis/trj_analysis/distmat_analysis/distmat_analysis artifacts/ || true
          cp src/analysis/trj_analysis/drms_analysis/drms_analysis artifacts/ || true
          cp src/analysis/trj_analysis/energy_analysis/energy_analysis artifacts/ || true
          cp src/analysis/trj_analysis/fret_analysis/fret_analysis artifacts/ || true
          cp src/analysis/trj_analysis/hb_analysis/hb_analysis artifacts/ || true
          cp src/analysis/trj_analysis/lipidthick_analysis/lipidthick_analysis artifacts/ || true
          cp src/analysis/trj_analysis/msd_analysis/msd_analysis artifacts/ || true
          cp src/analysis/trj_analysis/qval_analysis/qval_analysis artifacts/ || true
          cp src/analysis/trj_analysis/qval_residcg_analysis/qval_residcg_analysis artifacts/ || true
          cp src/analysis/trj_analysis/rg_analysis/rg_analysis artifacts/ || true
          cp src/analysis/trj_analysis/ring_analysis/ring_analysis artifacts/ || true
          cp src/analysis/trj_analysis/rmsd_analysis/rmsd_analysis artifacts/ || true
          cp src/analysis/trj_analysis/tilt_analysis/tilt_analysis artifacts/ || true
          cp src/analysis/trj_analysis/trj_analysis/trj_analysis artifacts/ || true
          # Utilities
          cp src/analysis/utilities/emmap_generator/emmap_generator artifacts/ || true
          cp src/analysis/utilities/morph_generator/morph_generator artifacts/ || true
          cp src/analysis/utilities/pathcv_analysis/pathcv_analysis artifacts/ || true
          cp src/analysis/utilities/qmmm_generator/qmmm_generator artifacts/ || true
          cp src/analysis/utilities/rpath_generator/rpath_generator artifacts/ || true
          # List what we have
          ls -la artifacts/

      - name: Upload GENESIS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: genesis-${{ matrix.os }}-${{ matrix.arch }}
          path: artifacts/
          retention-days: 7

  # Step 2: Build Python wheels
  build-wheels:
    needs: build-genesis
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            arch: x86_64
            cibw_archs: x86_64
          - os: macos-latest
            arch: arm64
            cibw_archs: arm64
          - os: macos-15
            arch: x86_64
            cibw_archs: x86_64
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Download GENESIS artifacts
        uses: actions/download-artifact@v4
        with:
          name: genesis-${{ matrix.os }}-${{ matrix.arch }}
          path: genesis-artifacts/

      - name: Prepare package with binaries
        run: |
          # Copy shared library to package
          cp genesis-artifacts/libpython_interface.* src/genepy/ || true
          # Copy all binaries (atdyn + analysis tools)
          mkdir -p src/genepy/bin
          for binary in genesis-artifacts/*; do
            if [ -f "$binary" ] && [ -x "$binary" ] && [[ ! "$binary" =~ \.(so|dylib)$ ]]; then
              cp "$binary" src/genepy/bin/
            fi
          done
          chmod +x src/genepy/bin/* 2>/dev/null || true
          # List package contents
          ls -la src/genepy/
          ls -la src/genepy/bin/ || true
          echo "Total binaries: $(ls src/genepy/bin/ | wc -l)"

      - name: Build wheels
        uses: pypa/cibuildwheel@v2.21
        env:
          # Only build for one Python version since our wheel is py3-none (universal Python 3)
          CIBW_BUILD: "cp311-*"
          CIBW_SKIP: "*-win32 *-manylinux_i686 *-musllinux*"
          CIBW_ARCHS: ${{ matrix.cibw_archs }}
          # Skip wheel repair - our shared library uses system libraries (libgfortran, LAPACK)
          # that are expected to be present on user systems
          CIBW_REPAIR_WHEEL_COMMAND_LINUX: "cp {wheel} {dest_dir}/"
          CIBW_REPAIR_WHEEL_COMMAND_MACOS: "cp {wheel} {dest_dir}/"
          # Test the wheel with multiple Python versions
          CIBW_TEST_COMMAND: >
            python -c "import genepy; print('genepy imported successfully')"

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.os }}-${{ matrix.arch }}
          path: ./wheelhouse/*.whl
          retention-days: 7

  # Step 3: Build source distribution
  build-sdist:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install build tools
        run: pip install build

      - name: Build sdist
        run: python -m build --sdist

      - name: Upload sdist
        uses: actions/upload-artifact@v4
        with:
          name: sdist
          path: dist/*.tar.gz
          retention-days: 7

  # Step 4: Publish to PyPI
  publish:
    needs: [build-wheels, build-sdist]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    environment:
      name: pypi
      url: https://pypi.org/p/genepy
    permissions:
      id-token: write  # Required for trusted publishing

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          merge-multiple: true
          path: dist/

      - name: Download sdist
        uses: actions/download-artifact@v4
        with:
          name: sdist
          path: dist/

      - name: List distribution files
        run: ls -la dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        # Uses trusted publishing - no API token needed if configured on PyPI

  # Optional: Publish to TestPyPI for testing
  publish-testpypi:
    needs: [build-wheels, build-sdist]
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    environment:
      name: testpypi
      url: https://test.pypi.org/p/genepy
    permissions:
      id-token: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          merge-multiple: true
          path: dist/

      - name: Download sdist
        uses: actions/download-artifact@v4
        with:
          name: sdist
          path: dist/

      - name: Publish to TestPyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/
