name: Build and publish wheels

on:
  push:
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
      - pypi
  workflow_dispatch:

jobs:
  # Step 1a: Build GENESIS for Linux in manylinux container (for glibc compatibility)
  build-genesis-linux:
    runs-on: ubuntu-latest
    container:
      image: quay.io/pypa/manylinux_2_28_x86_64
    steps:
      - uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          # Install Fortran compiler and build tools
          yum install -y gcc-gfortran lapack-devel blas-devel autoconf automake libtool
          # Check versions
          gfortran --version
          gcc --version

      - name: Generate configure script
        run: |
          autoreconf -fi

      - name: Configure GENESIS (no MPI)
        run: |
          # Avoid libmvec symbols (_ZGVdN4v_cos etc.) by:
          # 1. Removing -ffast-math (triggers libmvec usage)
          # 2. Disabling all vectorization
          # 3. Using basic x86-64 architecture (no AVX)
          ./configure --disable-mpi CC=gcc FC=gfortran \
            FCFLAGS="-O2 -march=x86-64 -fno-tree-vectorize -fno-tree-loop-vectorize -fno-tree-slp-vectorize -ffree-line-length-none -fallow-argument-mismatch -fopenmp -fPIC" \
            LDFLAGS="-fopenmp -lmvec -lm" \
            LAPACK_LIBS="-llapack -lblas"

      - name: Build GENESIS
        run: |
          make -j$(nproc)
          make install

      - name: Verify library dependencies
        run: |
          echo "=== Checking shared library dependencies ==="
          ldd lib/libpython_interface.so || true
          echo "=== Checking glibc version requirement ==="
          objdump -T lib/libpython_interface.so | grep GLIBC | sed 's/.*GLIBC_//' | sort -V | tail -5

      - name: Prepare artifacts
        run: |
          mkdir -p artifacts
          # Copy shared library
          cp lib/libpython_interface.so artifacts/ || true
          # Copy atdyn binary
          cp src/atdyn/atdyn artifacts/ || true
          # Copy all analysis tool binaries
          # Clustering
          cp src/analysis/clustering/kmeans_clustering/kmeans_clustering artifacts/ || true
          # Converters
          cp src/analysis/converter/cg_convert/cg_convert artifacts/ || true
          cp src/analysis/converter/crd_convert/crd_convert artifacts/ || true
          cp src/analysis/converter/pcrd_convert/pcrd_convert artifacts/ || true
          cp src/analysis/converter/remd_convert/remd_convert artifacts/ || true
          cp src/analysis/converter/rst_convert/rst_convert artifacts/ || true
          cp src/analysis/converter/rst_upgrade/rst_upgrade artifacts/ || true
          # Free energy
          cp src/analysis/free_energy/mbar_analysis/mbar_analysis artifacts/ || true
          cp src/analysis/free_energy/meanforce_analysis/meanforce_analysis artifacts/ || true
          cp src/analysis/free_energy/pmf_analysis/pmf_analysis artifacts/ || true
          cp src/analysis/free_energy/wham_analysis/wham_analysis artifacts/ || true
          # Interface
          cp src/analysis/interface/dssp_interface/dssp_interface artifacts/ || true
          # Mode analysis
          cp src/analysis/mode_analysis/avecrd_analysis/avecrd_analysis artifacts/ || true
          cp src/analysis/mode_analysis/eigmat_analysis/eigmat_analysis artifacts/ || true
          cp src/analysis/mode_analysis/flccrd_analysis/flccrd_analysis artifacts/ || true
          cp src/analysis/mode_analysis/pcavec_drawer/pcavec_drawer artifacts/ || true
          cp src/analysis/mode_analysis/prjcrd_analysis/prjcrd_analysis artifacts/ || true
          # SP analysis
          cp src/analysis/sp_analysis/contact_analysis/contact_analysis artifacts/ || true
          cp src/analysis/sp_analysis/density_analysis/density_analysis artifacts/ || true
          cp src/analysis/sp_analysis/hbond_analysis/hbond_analysis artifacts/ || true
          cp src/analysis/sp_analysis/rdf_analysis/rdf_analysis artifacts/ || true
          cp src/analysis/sp_analysis/sasa_analysis/sasa_analysis artifacts/ || true
          # Trajectory analysis
          cp src/analysis/trj_analysis/comcrd_analysis/comcrd_analysis artifacts/ || true
          cp src/analysis/trj_analysis/diffusion_analysis/diffusion_analysis artifacts/ || true
          cp src/analysis/trj_analysis/distmat_analysis/distmat_analysis artifacts/ || true
          cp src/analysis/trj_analysis/drms_analysis/drms_analysis artifacts/ || true
          cp src/analysis/trj_analysis/energy_analysis/energy_analysis artifacts/ || true
          cp src/analysis/trj_analysis/fret_analysis/fret_analysis artifacts/ || true
          cp src/analysis/trj_analysis/hb_analysis/hb_analysis artifacts/ || true
          cp src/analysis/trj_analysis/lipidthick_analysis/lipidthick_analysis artifacts/ || true
          cp src/analysis/trj_analysis/msd_analysis/msd_analysis artifacts/ || true
          cp src/analysis/trj_analysis/qval_analysis/qval_analysis artifacts/ || true
          cp src/analysis/trj_analysis/qval_residcg_analysis/qval_residcg_analysis artifacts/ || true
          cp src/analysis/trj_analysis/rg_analysis/rg_analysis artifacts/ || true
          cp src/analysis/trj_analysis/ring_analysis/ring_analysis artifacts/ || true
          cp src/analysis/trj_analysis/rmsd_analysis/rmsd_analysis artifacts/ || true
          cp src/analysis/trj_analysis/tilt_analysis/tilt_analysis artifacts/ || true
          cp src/analysis/trj_analysis/trj_analysis/trj_analysis artifacts/ || true
          # Utilities
          cp src/analysis/utilities/emmap_generator/emmap_generator artifacts/ || true
          cp src/analysis/utilities/morph_generator/morph_generator artifacts/ || true
          cp src/analysis/utilities/pathcv_analysis/pathcv_analysis artifacts/ || true
          cp src/analysis/utilities/qmmm_generator/qmmm_generator artifacts/ || true
          cp src/analysis/utilities/rpath_generator/rpath_generator artifacts/ || true
          # List what we have
          ls -la artifacts/

      - name: Upload GENESIS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: genesis-linux-x86_64
          path: artifacts/
          retention-days: 7

  # Step 1a-2: Build GENESIS for Linux ARM64 using QEMU
  build-genesis-linux-arm64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Build in ARM64 container
        run: |
          docker run --rm --platform linux/arm64 \
            -v "${{ github.workspace }}:/workspace" \
            -w /workspace \
            quay.io/pypa/manylinux_2_28_aarch64 \
            /bin/bash -c '
              set -e
              # Install build dependencies
              # Use gcc-toolset-14 for consistent compiler versions (gcc + gfortran)
              yum install -y gcc-toolset-14-gcc gcc-toolset-14-gcc-gfortran lapack-devel blas-devel autoconf automake libtool
              # Enable gcc-toolset-14
              source /opt/rh/gcc-toolset-14/enable
              echo "Using GCC from: $(which gcc)"
              gfortran --version
              gcc --version

              # Generate configure script
              autoreconf -fi

              # Configure GENESIS for ARM64
              # Note: configure.ac may override FCFLAGS, so we pass them to make as well
              FCFLAGS_ARM64="-O2 -march=armv8-a -fno-tree-vectorize -fno-tree-loop-vectorize -fno-tree-slp-vectorize -ffree-line-length-none -fallow-argument-mismatch -fopenmp -fPIC"
              ./configure --disable-mpi CC=gcc FC=gfortran \
                FCFLAGS="${FCFLAGS_ARM64}" \
                CFLAGS="-O2 -march=armv8-a -fno-tree-vectorize -fPIC" \
                LDFLAGS="-fopenmp -L/usr/lib64" \
                LAPACK_LIBS="-L/usr/lib64 -llapack -lblas"

              # Build GENESIS - override FCFLAGS to ensure ARM64 flags are used
              make -j$(nproc) FCFLAGS="${FCFLAGS_ARM64}"
              make install

              # Verify library dependencies
              echo "=== Checking shared library dependencies ==="
              ldd lib/libpython_interface.so || true
              echo "=== Checking glibc version requirement ==="
              objdump -T lib/libpython_interface.so | grep GLIBC | sed "s/.*GLIBC_//" | sort -V | tail -5

              # Prepare artifacts
              mkdir -p artifacts
              cp lib/libpython_interface.so artifacts/ || true
              cp src/atdyn/atdyn artifacts/ || true
              # Clustering
              cp src/analysis/clustering/kmeans_clustering/kmeans_clustering artifacts/ || true
              # Converters
              cp src/analysis/converter/cg_convert/cg_convert artifacts/ || true
              cp src/analysis/converter/crd_convert/crd_convert artifacts/ || true
              cp src/analysis/converter/pcrd_convert/pcrd_convert artifacts/ || true
              cp src/analysis/converter/remd_convert/remd_convert artifacts/ || true
              cp src/analysis/converter/rst_convert/rst_convert artifacts/ || true
              cp src/analysis/converter/rst_upgrade/rst_upgrade artifacts/ || true
              # Free energy
              cp src/analysis/free_energy/mbar_analysis/mbar_analysis artifacts/ || true
              cp src/analysis/free_energy/meanforce_analysis/meanforce_analysis artifacts/ || true
              cp src/analysis/free_energy/pmf_analysis/pmf_analysis artifacts/ || true
              cp src/analysis/free_energy/wham_analysis/wham_analysis artifacts/ || true
              # Interface
              cp src/analysis/interface/dssp_interface/dssp_interface artifacts/ || true
              # Mode analysis
              cp src/analysis/mode_analysis/avecrd_analysis/avecrd_analysis artifacts/ || true
              cp src/analysis/mode_analysis/eigmat_analysis/eigmat_analysis artifacts/ || true
              cp src/analysis/mode_analysis/flccrd_analysis/flccrd_analysis artifacts/ || true
              cp src/analysis/mode_analysis/pcavec_drawer/pcavec_drawer artifacts/ || true
              cp src/analysis/mode_analysis/prjcrd_analysis/prjcrd_analysis artifacts/ || true
              # SP analysis
              cp src/analysis/sp_analysis/contact_analysis/contact_analysis artifacts/ || true
              cp src/analysis/sp_analysis/density_analysis/density_analysis artifacts/ || true
              cp src/analysis/sp_analysis/hbond_analysis/hbond_analysis artifacts/ || true
              cp src/analysis/sp_analysis/rdf_analysis/rdf_analysis artifacts/ || true
              cp src/analysis/sp_analysis/sasa_analysis/sasa_analysis artifacts/ || true
              # Trajectory analysis
              cp src/analysis/trj_analysis/comcrd_analysis/comcrd_analysis artifacts/ || true
              cp src/analysis/trj_analysis/diffusion_analysis/diffusion_analysis artifacts/ || true
              cp src/analysis/trj_analysis/distmat_analysis/distmat_analysis artifacts/ || true
              cp src/analysis/trj_analysis/drms_analysis/drms_analysis artifacts/ || true
              cp src/analysis/trj_analysis/energy_analysis/energy_analysis artifacts/ || true
              cp src/analysis/trj_analysis/fret_analysis/fret_analysis artifacts/ || true
              cp src/analysis/trj_analysis/hb_analysis/hb_analysis artifacts/ || true
              cp src/analysis/trj_analysis/lipidthick_analysis/lipidthick_analysis artifacts/ || true
              cp src/analysis/trj_analysis/msd_analysis/msd_analysis artifacts/ || true
              cp src/analysis/trj_analysis/qval_analysis/qval_analysis artifacts/ || true
              cp src/analysis/trj_analysis/qval_residcg_analysis/qval_residcg_analysis artifacts/ || true
              cp src/analysis/trj_analysis/rg_analysis/rg_analysis artifacts/ || true
              cp src/analysis/trj_analysis/ring_analysis/ring_analysis artifacts/ || true
              cp src/analysis/trj_analysis/rmsd_analysis/rmsd_analysis artifacts/ || true
              cp src/analysis/trj_analysis/tilt_analysis/tilt_analysis artifacts/ || true
              cp src/analysis/trj_analysis/trj_analysis/trj_analysis artifacts/ || true
              # Utilities
              cp src/analysis/utilities/emmap_generator/emmap_generator artifacts/ || true
              cp src/analysis/utilities/morph_generator/morph_generator artifacts/ || true
              cp src/analysis/utilities/pathcv_analysis/pathcv_analysis artifacts/ || true
              cp src/analysis/utilities/qmmm_generator/qmmm_generator artifacts/ || true
              cp src/analysis/utilities/rpath_generator/rpath_generator artifacts/ || true
              # List what we have
              ls -la artifacts/
            '

      - name: Upload GENESIS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: genesis-linux-aarch64
          path: artifacts/
          retention-days: 7

  # Step 1b: Build GENESIS for macOS (native builds)
  build-genesis-macos:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            arch: arm64
          - os: macos-15
            arch: x86_64
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies (macOS)
        run: |
          brew install gcc lapack autoconf automake libtool
          # Create symlink for gfortran (Homebrew installs versioned, e.g., gfortran-14 or gfortran-15)
          GFORTRAN=$(ls $(brew --prefix)/bin/gfortran-* 2>/dev/null | sort -V | tail -1)
          if [ -n "$GFORTRAN" ]; then
            sudo ln -sf "$GFORTRAN" /usr/local/bin/gfortran
            echo "Linked gfortran: $GFORTRAN"
          fi

      - name: Generate configure script
        run: |
          autoreconf -fi

      - name: Configure GENESIS (no MPI)
        run: |
          # macOS - find the highest versioned gcc
          GCC=$(ls $(brew --prefix)/bin/gcc-* 2>/dev/null | grep -E 'gcc-[0-9]+$' | sort -V | tail -1)
          echo "Using GCC: $GCC"
          ./configure --disable-mpi CC="$GCC" FC=gfortran LAPACK_LIBS="-L$(brew --prefix lapack)/lib -llapack -lblas"

      - name: Build GENESIS
        run: |
          make -j$(sysctl -n hw.ncpu)
          make install

      - name: Prepare artifacts
        run: |
          mkdir -p artifacts
          # Copy shared library
          cp lib/libpython_interface.so artifacts/ || cp lib/libpython_interface.dylib artifacts/ || true
          # Copy atdyn binary
          cp src/atdyn/atdyn artifacts/ || true
          # Copy all analysis tool binaries
          # Clustering
          cp src/analysis/clustering/kmeans_clustering/kmeans_clustering artifacts/ || true
          # Converters
          cp src/analysis/converter/cg_convert/cg_convert artifacts/ || true
          cp src/analysis/converter/crd_convert/crd_convert artifacts/ || true
          cp src/analysis/converter/pcrd_convert/pcrd_convert artifacts/ || true
          cp src/analysis/converter/remd_convert/remd_convert artifacts/ || true
          cp src/analysis/converter/rst_convert/rst_convert artifacts/ || true
          cp src/analysis/converter/rst_upgrade/rst_upgrade artifacts/ || true
          # Free energy
          cp src/analysis/free_energy/mbar_analysis/mbar_analysis artifacts/ || true
          cp src/analysis/free_energy/meanforce_analysis/meanforce_analysis artifacts/ || true
          cp src/analysis/free_energy/pmf_analysis/pmf_analysis artifacts/ || true
          cp src/analysis/free_energy/wham_analysis/wham_analysis artifacts/ || true
          # Interface
          cp src/analysis/interface/dssp_interface/dssp_interface artifacts/ || true
          # Mode analysis
          cp src/analysis/mode_analysis/avecrd_analysis/avecrd_analysis artifacts/ || true
          cp src/analysis/mode_analysis/eigmat_analysis/eigmat_analysis artifacts/ || true
          cp src/analysis/mode_analysis/flccrd_analysis/flccrd_analysis artifacts/ || true
          cp src/analysis/mode_analysis/pcavec_drawer/pcavec_drawer artifacts/ || true
          cp src/analysis/mode_analysis/prjcrd_analysis/prjcrd_analysis artifacts/ || true
          # SP analysis
          cp src/analysis/sp_analysis/contact_analysis/contact_analysis artifacts/ || true
          cp src/analysis/sp_analysis/density_analysis/density_analysis artifacts/ || true
          cp src/analysis/sp_analysis/hbond_analysis/hbond_analysis artifacts/ || true
          cp src/analysis/sp_analysis/rdf_analysis/rdf_analysis artifacts/ || true
          cp src/analysis/sp_analysis/sasa_analysis/sasa_analysis artifacts/ || true
          # Trajectory analysis
          cp src/analysis/trj_analysis/comcrd_analysis/comcrd_analysis artifacts/ || true
          cp src/analysis/trj_analysis/diffusion_analysis/diffusion_analysis artifacts/ || true
          cp src/analysis/trj_analysis/distmat_analysis/distmat_analysis artifacts/ || true
          cp src/analysis/trj_analysis/drms_analysis/drms_analysis artifacts/ || true
          cp src/analysis/trj_analysis/energy_analysis/energy_analysis artifacts/ || true
          cp src/analysis/trj_analysis/fret_analysis/fret_analysis artifacts/ || true
          cp src/analysis/trj_analysis/hb_analysis/hb_analysis artifacts/ || true
          cp src/analysis/trj_analysis/lipidthick_analysis/lipidthick_analysis artifacts/ || true
          cp src/analysis/trj_analysis/msd_analysis/msd_analysis artifacts/ || true
          cp src/analysis/trj_analysis/qval_analysis/qval_analysis artifacts/ || true
          cp src/analysis/trj_analysis/qval_residcg_analysis/qval_residcg_analysis artifacts/ || true
          cp src/analysis/trj_analysis/rg_analysis/rg_analysis artifacts/ || true
          cp src/analysis/trj_analysis/ring_analysis/ring_analysis artifacts/ || true
          cp src/analysis/trj_analysis/rmsd_analysis/rmsd_analysis artifacts/ || true
          cp src/analysis/trj_analysis/tilt_analysis/tilt_analysis artifacts/ || true
          cp src/analysis/trj_analysis/trj_analysis/trj_analysis artifacts/ || true
          # Utilities
          cp src/analysis/utilities/emmap_generator/emmap_generator artifacts/ || true
          cp src/analysis/utilities/morph_generator/morph_generator artifacts/ || true
          cp src/analysis/utilities/pathcv_analysis/pathcv_analysis artifacts/ || true
          cp src/analysis/utilities/qmmm_generator/qmmm_generator artifacts/ || true
          cp src/analysis/utilities/rpath_generator/rpath_generator artifacts/ || true
          # List what we have
          ls -la artifacts/

      - name: Upload GENESIS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: genesis-${{ matrix.os }}-${{ matrix.arch }}
          path: artifacts/
          retention-days: 7

  # Step 2: Build Python wheels
  build-wheels:
    needs: [build-genesis-linux, build-genesis-linux-arm64, build-genesis-macos]
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            artifact: genesis-linux-x86_64
            cibw_archs: x86_64
          - os: ubuntu-latest
            artifact: genesis-linux-aarch64
            cibw_archs: aarch64
          - os: macos-latest
            artifact: genesis-macos-latest-arm64
            cibw_archs: arm64
          - os: macos-15
            artifact: genesis-macos-15-x86_64
            cibw_archs: x86_64
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Download GENESIS artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: genesis-artifacts/

      - name: Prepare package with binaries
        run: |
          # Restore execute permissions (lost during artifact download)
          chmod +x genesis-artifacts/* 2>/dev/null || true
          ls -la genesis-artifacts/
          # Copy shared library to package
          cp genesis-artifacts/libpython_interface.* src/genepie/ || true
          # Copy all binaries (atdyn + analysis tools)
          mkdir -p src/genepie/bin
          for binary in genesis-artifacts/*; do
            if [ -f "$binary" ] && [[ ! "$binary" =~ \.(so|dylib)$ ]]; then
              cp "$binary" src/genepie/bin/
            fi
          done
          chmod +x src/genepie/bin/* 2>/dev/null || true
          # List package contents
          ls -la src/genepie/
          ls -la src/genepie/bin/ || true
          echo "Total binaries: $(ls src/genepie/bin/ | wc -l)"

      - name: Build wheels
        uses: pypa/cibuildwheel@v2.21
        env:
          # Only build for one Python version since our wheel is py3-none (universal Python 3)
          CIBW_BUILD: "cp311-*"
          CIBW_SKIP: "*-win32 *-manylinux_i686 *-musllinux*"
          CIBW_ARCHS: ${{ matrix.cibw_archs }}
          # Tag wheels with proper platform tags for PyPI compatibility
          # - Linux: use manylinux_2_28 (built in manylinux_2_28 container, glibc 2.28+)
          # - macOS: use macosx tags
          # Note: We use wheel tags instead of auditwheel repair because our shared
          # library depends on system libraries (libgfortran, LAPACK) that cannot be bundled
          CIBW_REPAIR_WHEEL_COMMAND_LINUX: >
            pip install wheel &&
            WHEEL_DIR=$(mktemp -d) &&
            unzip -q {wheel} -d $WHEEL_DIR &&
            sed -i 's/linux_x86_64/manylinux_2_28_x86_64/g' $WHEEL_DIR/*.dist-info/WHEEL &&
            sed -i 's/linux_aarch64/manylinux_2_28_aarch64/g' $WHEEL_DIR/*.dist-info/WHEEL &&
            python -m wheel pack $WHEEL_DIR -d {dest_dir} &&
            rm -rf $WHEEL_DIR
          # macOS: fix platform tags for broader compatibility
          # - arm64: use macosx_11_0 (minimum for Apple Silicon)
          # - x86_64: use macosx_10_14 (Mojave, broad compatibility)
          CIBW_REPAIR_WHEEL_COMMAND_MACOS: >
            pip install wheel &&
            WHEEL_DIR=$(mktemp -d) &&
            unzip -q {wheel} -d $WHEEL_DIR &&
            if [[ "{wheel}" == *"arm64"* ]]; then
              sed -i '' 's/macosx_[0-9]*_[0-9]*_arm64/macosx_11_0_arm64/g' $WHEEL_DIR/*.dist-info/WHEEL;
            else
              sed -i '' 's/macosx_[0-9]*_[0-9]*_x86_64/macosx_10_14_x86_64/g' $WHEEL_DIR/*.dist-info/WHEEL;
            fi &&
            python -m wheel pack $WHEEL_DIR -d {dest_dir} &&
            rm -rf $WHEEL_DIR
          # Skip tests on Linux because the test container (manylinux2014, glibc 2.17)
          # cannot install manylinux_2_28 wheels (requires glibc 2.28+)
          CIBW_TEST_SKIP: "*-manylinux*"
          # Test that the package can be imported (macOS only)
          CIBW_TEST_COMMAND: >
            python -c "import genepie; print('genepie imported successfully')"

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.os }}-${{ matrix.cibw_archs }}
          path: ./wheelhouse/*.whl
          retention-days: 7

  # Step 3: Build source distribution
  build-sdist:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install build tools
        run: pip install build

      - name: Build sdist
        run: python -m build --sdist

      - name: Upload sdist
        uses: actions/upload-artifact@v4
        with:
          name: sdist
          path: dist/*.tar.gz
          retention-days: 7

  # Step 4: Publish to PyPI
  publish:
    needs: [build-wheels, build-sdist]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    environment:
      name: pypi
      url: https://pypi.org/p/genepie
    permissions:
      id-token: write  # Required for trusted publishing

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          merge-multiple: true
          path: dist/

      - name: Download sdist
        uses: actions/download-artifact@v4
        with:
          name: sdist
          path: dist/

      - name: List distribution files
        run: ls -la dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        # Uses trusted publishing - no API token needed if configured on PyPI

  # Optional: Publish to TestPyPI for testing
  publish-testpypi:
    needs: [build-wheels, build-sdist]
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    environment:
      name: testpypi
      url: https://test.pypi.org/p/genepie
    permissions:
      id-token: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          merge-multiple: true
          path: dist/

      - name: Download sdist
        uses: actions/download-artifact@v4
        with:
          name: sdist
          path: dist/

      - name: Publish to TestPyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/
